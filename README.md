# Platform Automation Reference Pipelines

The structure of this directory allows for multiple environments to be represented in a single repository.

## Pipelines

* `installation-dependencies-pipeline` - installs dependencies from pivnet into an s3-compatible blobstore
* `install-foundation-pipeline` - installs foundation tiles such as pks, harbor, and prometheus

## Environments

The `environments` folder holds the configuration in a `config` subfolder for all the deployments of a given foundation.

### Configuration

Within each foundation folder there can be multiple subfolders:

* `defaults` - this folder contains the default values for a given tile.  This is generated by `om config-template` **Promotable**

* `templates` - this folder contains the resulting interpolated template based on operations files that have been applied to the output of `om config-template`.  This is created by `scripts/generate-config.sh` **Promotable**

* `vars` - this folder contains environment specific variables per product that is being deployed. **Not Promotable**

* `secrets` - this folder contains the templates that can be interpolated using `credhub interpolate` to be used as secrets inputs to other tasks **Promotable**

* `versions` - this folder contains both the product version and stemcell version per product. **Promotable**

* `errands` - this folder contains a file with a list of errand names to run per product.  Ideally this would be a proper yaml file but for now it's easier to read errand names via bash.  Used by `run-errands` task in `proposed-tasks`

## State

Used to store ops manager `state.yml` file leveraged by `create-vm` task.  Folder structure mimics environment `environments/<foundation name>`

## Proposed Tasks

* `apply-product-changes` - task to allow specifying selective deploy for a single product

* `download-create-opsman` - this task is an aggregate that will try to short-circuit and not download opsmanager if state file has content otherwise with download opsmanager via `om download-product` and create it via `p-automator create-vm`

* `download-upgrade-opsman` - this task is an aggregate that will short-circuit and not download opsmanager if the version installed is the version expected.  This optimization only works in 2.5.x due to how opsmanager versioning worked prior to 2.5.x.  If version mismatches it will download product via `om download-product` and update vm via `p-automator upgrade-opsman`

* `download-stage-tile-stemcell` - this task is an aggregrate that will only download the tile if that version is not already staged.  It will also only download the expected stemcell if that version hasn't already been uploaded.  Otherwise it will download both tile and stemcell using `om download-product`, upload tile and stemcell, stage tile and assign the specified stemcell version to the tile (always regardless of download)

* `make-commit` - this task avoids committing `state.yml` using `porcelain` option. PR has been accepted so this task will be replace with platform-automation task once it's shipped.

* `run-errands` - this task will leverage a file in the configuration directory `<environment>/<config>/<errands>/<product>` to determine what errands to run.  The approach here disables all errands from being ran in the `apply-changes` flow and then will run them directly via bosh to allow parallel running the errand(s) after `apply-changes` for a given product has succeeded in the pipeline.

## Scripts

* `generate-config.sh <product-name> <foundation-name>` - this script uses `om config-template` to generate yaml configuration, defaults, etc. applying operations that lie in `<product>`-operations.  Currently places the results in the first environment `environments/<foundation/config`

* `validate-config.sh <product-name> <foundation-name>` - this script validates that all properties that are needed to interpolate the template in `environments/<foundation>/config/templates/<product-name>.yml` are defined. This uses vars files from `environments/<foundation>/config/defaults/<product-name>.yml`, `environments/<foundation/config/vars/<product-name>.yml`, `environments/<foundation/config/secrets/<product-name>.yml`

## Credentials Management

Credentials including certificates, passwords ssh keys, etc. are stored in the [Control Plane](https://network.pivotal.io/products/p-control-plane-components/) [Credhub](http://credhub-api.cfapps.io) and used by [Concourse](https://concourse-ci.org/credhub-credential-manager.html) and [Platform Automation](https://docs.pivotal.io/platform-automation/).

### Main Pipeline Secrets

Generated by [credhub-generate-pipeline-secrets.sh](#credhub-generate-pipeline-secrets)

* `/concourse/main/credhub_ca`
* `/concourse/main/credhub_client`
* `/concourse/main/credhub_secret`
* `/concourse/main/credhub_server`
* `/concourse/main/pivnet_token`
* `/concourse/main/git_ssh_key`
* `/concourse/main/s3_access_key_id`
* `/concourse/main/s3_secret_access_key`
* `/concourse/main/s3_endpoint`
* `/concourse/main/s3_backups_bucket`
* `/concourse/main/s3_products_bucket`
* `/concourse/main/s3_installations_bucket`

### Platform Environment Secrets

Generated by [credhub-generate-platform-secrets.sh](#credhub-generate-platform-secrets)

* `/platform-automation/((env))/harbor_admin_password`
* `/platform-automation/((env))/nsx_admin_password`
* `/platform-automation/((env))/opsman_hostname`
* `/platform-automation/((env))/opsman_username`
* `/platform-automation/((env))/opsman_password`
* `/platform-automation/((env))/opsman_ssh_password`
* `/platform-automation/((env))/opsman_decryption_passphrase`
* `/platform-automation/((env))/pivnet_token`
* `/platform-automation/((env))/vcenter_password`
* `/platform-automation/((env))/vcenter_username`

### Platform Environment Certificates

Generated by [credhub-generate-certificate-authority.sh](#credhub-generate-certificate-authority)

* `/platform-automation/certificate_authority`

Generated by [credhub-generate-platform-certificates.sh](#credhub-generate-platform-certificates) using the CA from [credhub-generate-certificate-authority.sh](#credhub-generate-certificate-authority)

* `/platform-automation/((env))/pas_tls`
* `/platform-automation/((env))/pks_tls`
* `/platform-automation/((env))/harbor_tls`
* `/platform-automation/((env))/nsx_tls`

### Scripts

* <a name="credhub-generate-certificate-authority"></a>`credhub-generate-certificate-authority.sh` - creates the Certificate Authority using the [Control Plane Credhub](https://network.pivotal.io/products/p-control-plane-components/)

* <a name="credhub-generate-pipeline-secrets"></a>`credhub-generate-pipeline-secrets.sh` - creates secrets used by all the pipelines.

* <a name="credhub-generate-platform-secrets"></a>`credhub-generate-platform-secrets.sh` - creates secrets used by platform-automation tasks for each environment. The secrets are stored under `/platform-automation/((env))` where `env` corresponds to a environment name (such as: sandbox, dev, uat, prod)

* <a name="credhub-generate-platform-certificates"></a>`credhub-generate-platform-certificates.sh` - creates certs used by platform-automation tasks
